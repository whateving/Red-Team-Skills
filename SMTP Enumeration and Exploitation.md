# Understanding SMTP (Simple Mail Transfer Protocol)

## What Is SMTP?

**SMTP** stands for **Simple Mail Transfer Protocol**. It is the protocol responsible for **sending** emails.  
To fully support email communication, SMTP is paired with **POP** or **IMAP**, which handle **receiving** emails.

In short:

- **SMTP** → sends outgoing mail  
- **POP/IMAP** → retrieves incoming mail  

---

## What Does an SMTP Server Do?

An SMTP server has three main jobs:

1. **Check who is sending the email**  
2. **Send the message to the recipient’s mail server**  
3. **Return the email to the sender** if it cannot be delivered  

If you’ve ever set up an email client like Thunderbird or Outlook, you’ve likely seen SMTP settings—these are required for sending messages.

---

## POP vs IMAP

**POP (Post Office Protocol)** and **IMAP (Internet Message Access Protocol)** are used to retrieve emails from a mail server.

**POP:**
- Downloads emails from the server to your device  
- Usually removes them from the server afterward  
- Simple but does not sync between devices  

**IMAP:**
- Syncs your inbox with the mail server  
- Downloads only new or changed messages  
- Changes made on one device appear everywhere  

The POP/IMAP server handles delivering the inbox to the user.

---

## How Does SMTP Work?

You can think of email delivery like sending a physical letter:

- You write the message (email)  
- A postal system (SMTP) transports it  
- It eventually arrives at the recipient’s mailbox (inbox)  

SMTP acts like the **sorting office** that routes your message to the correct destination.

Here’s the simplified journey:

### 1. Email client connects to the SMTP server
Your email program connects to your provider’s SMTP server (e.g., `smtp.google.com`) over **port 25**.  
A handshake occurs, and an SMTP session begins.

### 2. The client sends message details
Your device sends:
- The sender’s email  
- The recipient’s email  
- The message body  
- Any attachments  

### 3. SMTP checks the domain
The server checks whether the sender and recipient share the same domain (e.g., both @gmail.com).

### 4. SMTP contacts the recipient’s server
If needed, the sender’s SMTP server connects to the **recipient’s SMTP server**.  
If the server is unavailable, the email is stored in an **SMTP queue** to retry later.

### 5. Recipient’s SMTP server validates the message
It verifies that:
- The domain exists  
- The user exists  

After validation, the email is passed to the recipient’s **POP/IMAP server** for mailbox delivery.

### 6. The email appears in the inbox
The email finally shows up for the recipient.

This is a simplified view—many additional checks and protocols happen behind the scenes.


# Enumeration Phase

## Enumerating Server Details

Before attacking a mail server, it's important to identify exactly what we're dealing with. Misconfigured or outdated SMTP servers can provide an easy entry point, but only if we enumerate them properly.  
To fingerprint the target, we can use the **`smtp_version`** module in Metasploit. As the name suggests, this module scans a single IP or a range of addresses and identifies the version of any SMTP servers it finds. This helps us understand what software the server is running and whether it may be vulnerable.

---

## Enumerating Users Through SMTP

SMTP includes two built-in commands that can be abused to discover valid usernames on a mail server:

- **VRFY** — checks whether a specific user exists  
- **EXPN** — expands aliases or mailing lists to show the real email addresses behind them  

By using these commands, an attacker can gather a list of valid users on the system.

While this can be done manually using a simple **telnet** connection, Metasploit provides a faster method. The **`smtp_enum`** module automates the process: you supply a target (or a range) and a list of potential usernames, and the module attempts to verify each one for you.


1. Run a port scan:
<img width="1445" height="229" alt="image" src="https://github.com/user-attachments/assets/add7859b-58b7-456e-8f45-5feea767d563" />

2. Launch Metasploit by running ```msfconsole```
3. Search for the following module by running ```search smtp_version```
4. Set RHOSTS, and run the exploit
<img width="1445" height="660" alt="image" src="https://github.com/user-attachments/assets/95556cbe-690e-42f3-b44b-504b898283ec" />

5. We found the system mail name: polosmtp.home
6.  Search for the following module by running ```search smtp_enum```
7.  Set the necessary options and run the exploit
<img width="1445" height="767" alt="image" src="https://github.com/user-attachments/assets/29308685-b746-45ad-bda0-48f317c85d32" />

We have successfully enumerated the smtp service and found a user on it.

# Exploiting SMTP

Now that we have the account name, we can brute-force the ssh password for it.

<img width="1445" height="688" alt="image" src="https://github.com/user-attachments/assets/e89d4631-40fd-4fc2-878b-dd29a2fc8f48" />

and we found the password for it:

<img width="1445" height="609" alt="image" src="https://github.com/user-attachments/assets/2c87bfac-4286-475e-b446-c25b1a4f344e" />

now we can just ssh into the machine with the newly acquired credentials.

