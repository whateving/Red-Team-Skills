# CVE-2024-21413 — Microsoft Outlook Moniker Link Vulnerability


On February 13th, 2024, Microsoft announced a Microsoft Outlook RCE & credential leak vulnerability with the assigned CVE of CVE-2024-21413 (Moniker Link). Haifei Li of Check Point Research is credited with discovering the vulnerability.

The vulnerability bypasses Outlook's security mechanisms when handling a specific type of hyperlink known as a Moniker Link. An attacker can abuse this by sending an email that contains a malicious Moniker Link to a victim, resulting in Outlook sending the user's NTLM credentials to the attacker once the hyperlink is clicked.

---

## CVSS Scoring Information

| CVSS | Description |
|------|-------------|
| Publish date | February 13th, 2024 |
| MS article | https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2024-21413 |
| Impact | Remote Code Execution & Credential Leak |
| Severity | Critical |
| Attack Complexity | Low |
| Scoring | 9.8 |

---

## Affected Office Versions

| Release | Version |
|---------|---------|
| Microsoft Office LTSC 2021 | affected from 19.0.0 |
| Microsoft 365 Apps for Enterprise | affected from 16.0.1 |
| Microsoft Office 2019 | affected from 16.0.1 |
| Microsoft Office 2016 | affected from 16.0.0 before 16.0.5435.1001 |

---

## Explanation

Moniker Links are URLs specifying applications to open.

Think of a Moniker Link as a "shortcut on steroids."

A Normal Link is like a map. It tells your computer, "The file is over there." Your computer goes there, stops, and asks, "Is this safe to open?"

A Moniker Link is like a command. It tells your computer, "Go there, grab that specific file, and run it immediately."

Why is it a problem? In the recent cyber security news, hackers found a way to use these links to sneak past the "security guards" (Protected View). Because the link looks special, the computer assumes it is trusted and opens the door without checking for danger first.

Think of Protected View as a "Clear Plastic Bag."

The Setup: When you bring a new toy (file) home from a stranger’s house (the Internet), your computer doesn't trust it yet.

The Protection: Before you can play with it, the computer puts the toy inside a sealed, clear plastic bag.

The Result: You can look at the toy and read the instructions through the plastic, but the toy cannot move, make noise, or hurt you.

How do you stop it? When you click the button that says "Enable Editing," you are tearing the plastic bag open. Now the toy is free to move around—but if it was a robot spider, it can now bite you!

The Moniker Link Problem: Remember the "Moniker Link" we talked about? It is a trick that teleports the robot spider directly onto your carpet, completely skipping the plastic bag stage.

---

# Exploitation

Set up the responder:

<img width="627" height="229" alt="image" src="https://github.com/user-attachments/assets/8b84b997-1905-4760-bcbb-58fde77d7e68" />


The following is the PoC I used for this hack.

<img width="627" height="374" alt="image" src="https://github.com/user-attachments/assets/eb433cb7-57a1-4cee-87c6-cf38241a9fd0" />

---

We run the exploit:

<img width="627" height="374" alt="image" src="https://github.com/user-attachments/assets/4f4a1737-0573-4d90-aa1d-c32d65eaa969" />


The email got delivered:

<img width="627" height="374" alt="image" src="https://github.com/user-attachments/assets/69fb0a0b-c484-4ed0-b0d1-592f7f6d80bd" />


We got the victim’s netNTLMv2 hash:

<img width="627" height="104" alt="image" src="https://github.com/user-attachments/assets/7ada4c62-13cf-41e5-b1bd-27cd745eb359" />

---

# Detection

## YARA

A Yara rule has been created by Florian Roth to detect emails containing the `file:\\` element in the Moniker Link.

### CVE-2024-21413 Yara rule created by Florian Roth

`https://twitter.com/cyb3rops/status/1758792873254744344`

```
user@yourmachine:# cat cve-2024-21413.yar 


rule EXPL_CVE_2024_21413_Microsoft_Outlook_RCE_Feb24 {

   meta:

      description = "Detects emails that contain signs of a method to exploit CVE-2024-21413 in Microsoft Outlook"

      author = "X__Junior, Florian Roth"

      reference = "https://github.com/xaitax/CVE-2024-21413-Microsoft-Outlook-Remote-Code-Execution-Vulnerability/"

      date = "2024-02-17"

      modified = "2024-02-19"

      score = 75

   strings:

      $a1 = "Subject: "

      $a2 = "Received: "



      $xr1 = /file:\/\/\/\\\\[^"']{6,600}\.(docx|txt|pdf|xlsx|pptx|odt|etc|jpg|png|gif|bmp|tiff|svg|mp4|avi|mov|wmv|flv|mkv|mp3|wav|aac|flac|ogg|wma|exe|msi|bat|cmd|ps1|zip|rar|7z|targz|iso|dll|sys|ini|cfg|reg|html|css|java|py|c|cpp|db|sql|mdb|accdb|sqlite|eml|pst|ost|mbox|htm|php|asp|jsp|xml|ttf|otf|woff|woff2|rtf|chm|hta|js|lnk|vbe|vbs|wsf|xls|xlsm|xltm|xlt|doc|docm|dot|dotm)!/

   condition:

      filesize < 1000KB

      and all of ($a*)

      and 1 of ($xr*)

}

```




